# NGOInfo-Copilot System Guide

## üéØ System Purpose

NGOInfo-Copilot is an AI-powered proposal generation service designed for NGOs to create professional grant proposals. It combines structured funding opportunity data from the ReqAgent service with intelligent NGO profiles to generate tailored proposals using OpenAI's API.

### Core Mission
- Generate AI-powered proposals for NGOs
- Combine structured funding info with smart NGO profiles
- Use donor-specific prompt templates for optimized results
- Provide editing capabilities and export functionality (DOCX/PDF)
- Track all generations, edits, and confidence scores

## üèóÔ∏è System Architecture

### Database Strategy
- **Shared Database**: PostgreSQL hosted on Railway (service: `ngoinfo-requirement-agent`)
- **ReqAgent Tables**: Read-only access to `funding_opportunities` table
- **Copilot Tables**: Full control over `ngo_profiles` and `proposals` tables

### Service Ecosystem
```
ReqAgent (External) ‚îÄ‚îÄ‚îê
                     ‚îÇ
                     ‚ñº
            PostgreSQL Database
                     ‚ñ≤
                     ‚îÇ
               NGOInfo-Copilot ‚îÄ‚îÄ‚îÄ‚îÄ OpenAI API
```

## üìä Database Schema

### ReqAgent Tables (Read-Only)
#### `funding_opportunities`
- Parsed and structured funding opportunities
- Contains eligibility criteria, focus areas, donor information
- Managed by ReqAgent service, not modified by Copilot

### Copilot Tables (Full Control)
#### `ngo_profiles`
- NGO organization profiles with detailed information
- Includes mission, focus areas, past projects, capacity
- Completeness scoring for optimization
- User-specific profiles (one per user_id)

#### `proposals`
- Generated proposals with full content
- Metadata: prompts, templates, scores, user feedback
- Version tracking and edit history
- Export tracking and status management

## üîó API Routes

### Profile Management (`/api/profile`)
- `POST /` - Create new NGO profile
- `GET /` - Get current user's profile
- `PUT /` - Update profile information
- `DELETE /` - Soft delete profile
- `GET /completeness` - Get profile completeness analysis

### Proposal Management (`/api/proposals`)
- `POST /generate` - Generate new proposal via AI
- `GET /` - List user's proposals (with pagination)
- `GET /{proposal_id}` - Get specific proposal
- `PUT /{proposal_id}` - Update proposal content
- `POST /{proposal_id}/rate` - Rate proposal (1-5 stars)
- `DELETE /{proposal_id}/archive` - Archive proposal
- `GET /{proposal_id}/export/{format}` - Export proposal (PDF/DOCX)

### Health Check
- `GET /healthcheck` - System health status

## üß† AI Prompt System

### Prompt Architecture
1. **Organization Profile**: Formatted NGO information
2. **Funding Opportunity**: Structured funding details
3. **Donor-Specific Guidelines**: Tailored templates
4. **Custom Instructions**: User-provided guidance
5. **General Requirements**: Standard proposal structure

### Donor Templates
- **Gates Foundation**: Evidence-based, measurable impact
- **Ford Foundation**: Social justice, human rights focus
- **Open Society**: Democracy, transparency, civil society
- **USAID**: Development objectives, sustainability
- **European Union**: EU values, multi-stakeholder approach
- **World Bank**: Poverty reduction, economic analysis
- **United Nations**: SDGs, multilateral cooperation
- **Default**: General best practices

### Fallback Logic
1. Try donor-specific template based on organization name
2. Use name normalization for common variations
3. Fall back to default template if no match found
4. Always include general best practices

## üé® Profile Formatting

### Completeness Scoring (0-100)
- **Required Fields** (high weight): organization_name, mission_statement, focus_areas, geographic_scope
- **Important Fields** (medium weight): founded_year, organization_type, website, programs_services
- **Optional Fields** (low weight): registration_number, contact_phone, awards_recognition

### Profile Optimization
- AI-generated optimization notes
- Missing field identification
- Completion recommendations
- Verification status tracking

## üîç Quality Scoring

### Proposal Scoring Metrics
1. **Confidence Score**: Content quality, length, structure
2. **Alignment Score**: Match with funding opportunity
3. **Completeness Score**: Required sections coverage

### Scoring Factors
- Word count and structure indicators
- Keyword alignment with funding opportunity
- Section presence (executive summary, budget, methodology)
- Organization-funding opportunity alignment

## üöÄ Deployment Strategy

### Railway Deployment
- **Platform**: Railway via GitHub integration
- **Database**: Shared PostgreSQL instance
- **Environment**: Production-ready with scaling
- **CI/CD**: Automatic deployment on main branch push

### Environment Variables
```
DATABASE_URL=postgresql://... (Railway managed)
OPENAI_API_KEY=sk-... (OpenAI API key)
```

### Scaling Considerations
- Async database operations
- Connection pooling configured
- Efficient prompt caching
- Rate limiting for OpenAI API

## ‚ö†Ô∏è Critical Constraints

### Database Constraints
- **NEVER** write to ReqAgent tables
- **NEVER** modify `funding_opportunities` table
- **ALWAYS** use read-only access for external tables
- **ALWAYS** handle database connection errors gracefully

### OpenAI API Constraints
- **NEVER** exceed rate limits
- **ALWAYS** handle API errors and timeouts
- **ALWAYS** log API usage for monitoring
- **CACHE** responses when appropriate

### Package Management
- **NEVER** reinstall packages without explicit instruction
- **NEVER** modify existing .env files
- **ALWAYS** use provided environment variables
- **ALWAYS** check existing dependencies before adding new ones

## üîß Development Guidelines

### Code Structure
- **Models**: SQLAlchemy models for database tables
- **Services**: Business logic and data processing
- **Routes**: FastAPI endpoints and request handling
- **Utils**: Common utilities (auth, scoring, OpenAI)
- **Prompts**: Template system and prompt building

### Error Handling
- **Comprehensive logging** at all levels
- **Graceful degradation** for external service failures
- **User-friendly error messages**
- **Database rollback** on transaction failures

### Authentication
- **Mock authentication** for development
- **JWT token validation** placeholder
- **User ID extraction** from tokens
- **Role-based access control** ready

## üîí Security Considerations

### Data Protection
- **Environment variables** for sensitive data
- **Database connection security**
- **API key management**
- **User data isolation**

### Access Control
- **User-specific data access**
- **Profile ownership validation**
- **Proposal access restrictions**
- **Admin function protection**

## üìà Monitoring and Analytics

### Metrics to Track
- **Proposal generation** success rates
- **User engagement** and ratings
- **Profile completeness** trends
- **API usage** and performance
- **Error rates** and patterns

### Logging Strategy
- **Structured logging** with context
- **Error tracking** and alerting
- **Performance monitoring**
- **User activity logging**

## üîÑ Integration Points

### ReqAgent Integration
- **Read-only access** to funding opportunities
- **Synchronization** of funding data
- **Error handling** for external service issues
- **Fallback mechanisms** for data unavailability

### OpenAI Integration
- **Prompt optimization** for better results
- **Model selection** based on requirements
- **Response parsing** and validation
- **Cost optimization** strategies

## üìö Technical Stack

### Core Technologies
- **FastAPI**: Web framework
- **SQLAlchemy**: Database ORM
- **Pydantic**: Data validation
- **asyncpg**: PostgreSQL async driver
- **OpenAI API**: AI content generation

### Supporting Libraries
- **python-docx**: Document generation
- **reportlab**: PDF generation
- **structlog**: Structured logging
- **python-jose**: JWT handling
- **httpx**: HTTP client

## üéõÔ∏è Configuration

### Database Configuration
- **Connection pooling**: 20 connections max
- **Async operations**: All database calls
- **Migration support**: Alembic ready
- **Error handling**: Comprehensive rollback

### OpenAI Configuration
- **Default model**: GPT-4
- **Max tokens**: 4000
- **Temperature**: 0.7 (balanced creativity)
- **Timeout handling**: Graceful degradation

## üö¶ Status and Health

### Health Check Endpoints
- `/healthcheck` - Basic service health
- Database connectivity check
- External service availability
- API key validation

### Monitoring Endpoints
- Service version information
- Database status
- OpenAI API status
- System metrics

## üìñ Usage Examples

### Creating a Profile
```bash
curl -X POST "http://localhost:8000/api/profile" \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "organization_name": "Example NGO",
    "mission_statement": "Supporting communities worldwide",
    "focus_areas": ["education", "healthcare"],
    "geographic_scope": ["Kenya", "Uganda"]
  }'
```

### Generating a Proposal
```bash
curl -X POST "http://localhost:8000/api/proposals/generate" \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "funding_opportunity_id": 123,
    "custom_instructions": "Focus on women empowerment"
  }'
```

## üõ†Ô∏è Troubleshooting

### Common Issues
1. **Database connection errors**: Check Railway service status
2. **OpenAI API failures**: Verify API key and rate limits
3. **Profile completeness low**: Guide users to fill missing fields
4. **Proposal generation fails**: Check prompt length and API limits

### Debug Mode
- Set `echo=True` in database engine for SQL logging
- Use structured logging for detailed debugging
- Monitor API response times and error rates

## üîÆ Future Enhancements

### Planned Features
- **Multi-language support** for proposals
- **Template customization** for organizations
- **Collaboration features** for team editing
- **Advanced analytics** and insights
- **Integration with more donors**

### Technical Improvements
- **Caching layer** for frequently accessed data
- **Background tasks** for long-running operations
- **Real-time notifications** for proposal updates
- **Advanced search** and filtering
- **API rate limiting** and throttling

---

*This guide serves as the comprehensive reference for the NGOInfo-Copilot system. Keep it updated as the system evolves.* 